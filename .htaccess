# ══════════════════════════════════════════════════════════════════
# THERAPY COUNCIL - ESSENTIAL SECURITY CONFIGURATION
# ══════════════════════════════════════════════════════════════════

# ┌──────────────────────────────────────────────────────────────────
# │ HTTPS ENFORCEMENT
# └──────────────────────────────────────────────────────────────────

RewriteEngine On

# Force HTTPS redirect (only if your hosting supports HTTPS)
# Uncomment the next 3 lines if you have SSL certificate
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ┌──────────────────────────────────────────────────────────────────
# │ ESSENTIAL SECURITY HEADERS
# └──────────────────────────────────────────────────────────────────

<IfModule mod_headers.c>
    # X-Frame-Options (Clickjacking protection)
    Header always set X-Frame-Options "DENY"
    
    # X-Content-Type-Options (MIME sniffing protection)
    Header always set X-Content-Type-Options "nosniff"
    
    # X-XSS-Protection (XSS filtering)
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server information
    Header unset Server
    Header always unset X-Powered-By
    
    # HSTS Header (only if you have HTTPS)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
</IfModule>

# ┌──────────────────────────────────────────────────────────────────
# │ FILE ACCESS RESTRICTIONS
# └──────────────────────────────────────────────────────────────────

# Deny access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|config|sql)$">
    Require all denied
</FilesMatch>

# Deny access to hidden files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Protect configuration files
<Files "package.json">
    Require all denied
</Files>

<Files "package-lock.json">
    Require all denied
</Files>

<Files "*.md">
    Require all denied
</Files>

# ┌──────────────────────────────────────────────────────────────────
# │ BASIC ATTACK PROTECTION
# └──────────────────────────────────────────────────────────────────

# Block common attack patterns
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} ^.*(<|>|'|%0A|%0D|%27|%3C|%3E|%00).* [NC,OR]
RewriteCond %{QUERY_STRING} (union.*select|insert.*into|delete.*from|select.*from) [NC]
RewriteRule .* - [F,L]

# Block suspicious user agents
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^(-|\.|') [OR]
RewriteCond %{HTTP_USER_AGENT} (bot|crawler|spider|scraper) [NC]
RewriteRule .* - [F,L]

# ┌──────────────────────────────────────────────────────────────────
# │ DIRECTORY SECURITY
# └──────────────────────────────────────────────────────────────────

# Disable directory browsing
Options -Indexes

# Disable server signature
ServerSignature Off

# ┌──────────────────────────────────────────────────────────────────
# │ CUSTOM ERROR PAGES
# └──────────────────────────────────────────────────────────────────

# Custom error pages (you'll create error.html next)
ErrorDocument 400 /error.html
ErrorDocument 401 /error.html
ErrorDocument 403 /error.html
ErrorDocument 404 /error.html
ErrorDocument 500 /error.html

# ┌──────────────────────────────────────────────────────────────────
# │ PERFORMANCE & CACHING (Security-aware)
# └──────────────────────────────────────────────────────────────────

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Cache static assets
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Don't cache HTML files (for security updates)
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ┌──────────────────────────────────────────────────────────────────
# │ FORM SECURITY
# └──────────────────────────────────────────────────────────────────

# Limit POST request size (prevent large payload attacks)
LimitRequestBody 1048576  # 1MB limit

# ┌──────────────────────────────────────────────────────────────────
# │ ADDITIONAL SECURITY
# └──────────────────────────────────────────────────────────────────

# Disable HTTP TRACE method (prevents XST attacks)
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} ^TRACE
    RewriteRule .* - [F]
</IfModule>

# Disable HTTP TRACK method
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} ^TRACK
    RewriteRule .* - [F]
</IfModule>

# ══════════════════════════════════════════════════════════════════
# END ESSENTIAL SECURITY CONFIGURATION
# ══════════════════════════════════════════════════════════════════